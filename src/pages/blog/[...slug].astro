---
import { getCollection } from 'astro:content';
import BlogLayout from '../../layouts/BlogLayout.astro';

export const prerender = true;

interface Props {
  entry: any;
  prevPost?: { title: string; path: string };
  nextPost?: { title: string; path: string };
}

export async function getStaticPaths() {
  const blogPosts = await getCollection('blog');

  // Sort posts by publish date (oldest first for navigation purposes)
  const sortedPosts = blogPosts.sort(
    (a, b) => a.data.publishDate.valueOf() - b.data.publishDate.valueOf()
  );

  return sortedPosts.map((entry, index) => {
    const slug = entry.slug;

    // Get previous and next posts for navigation
    const prevPost = index > 0 ? {
      title: sortedPosts[index - 1].data.title,
      path: `/blog/${sortedPosts[index - 1].slug}`
    } : undefined;

    const nextPost = index < sortedPosts.length - 1 ? {
      title: sortedPosts[index + 1].data.title,
      path: `/blog/${sortedPosts[index + 1].slug}`
    } : undefined;

    return {
      params: { slug },
      props: { entry, prevPost, nextPost },
    };
  });
}

const { entry, prevPost, nextPost } = Astro.props;
const { Content } = await entry.render();
const { title, description, author, publishDate, updatedDate, tags } = entry.data;

// Auto-assign OG image from slug
const ogImage = `/og-images/${entry.slug}.png`;

// Construct full post URL
const postUrl = new URL(`/blog/${entry.slug}`, Astro.site).href;
---

<BlogLayout
  title={title}
  description={description}
  author={author}
  publishDate={publishDate}
  updatedDate={updatedDate}
  tags={tags}
  ogImage={ogImage}
  postUrl={postUrl}
  prevPost={prevPost}
  nextPost={nextPost}
>
  <Content />
</BlogLayout>
