---
import { getCollection } from 'astro:content';
import type { ImageMetadata } from 'astro';
import { withBase } from '../lib/utils';
import PageHeading from './PageHeading.astro';
import PostCard from './PostCard.astro';
import { BlogCTA } from './BlogCTA';

const images = import.meta.glob('/src/content/blog/*/featured-image.webp', { eager: true });

const imageMap = Object.entries(images).reduce((acc, [path, module]) => {
  const slug = path.split('/').at(-2);
  if (!slug) {
    console.warn(`Invalid image path structure: ${path}`);
    return acc;
  }
  acc[slug] = (module as { default: ImageMetadata }).default;
  return acc;
}, {} as Record<string, ImageMetadata>);

const allPosts = await getCollection('blog');

const blogPosts = allPosts
  .sort((a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf())
  .slice(0, 3);

const featuredPost = blogPosts[0];
const secondaryPosts = blogPosts.slice(1, 3);

const featuredImage = featuredPost ? imageMap[featuredPost.slug] : undefined;
if (!featuredImage && featuredPost) {
  console.warn(`Missing featured image for post: ${featuredPost.slug}`);
}

const secondaryWithImages = secondaryPosts.map(post => ({
  post,
  image: imageMap[post.slug]
}));
---

<section class="max-w-3xl mx-auto px-6 py-12 md:py-16">
    <PageHeading text="The Augur Arc" />

    <div class="flex flex-col gap-8 md:gap-12">
      {featuredPost && (
        <PostCard
          title={featuredPost.data.title}
          description={featuredPost.data.description}
          date={featuredPost.data.publishDate.toLocaleDateString('en-US', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
          })}
          image={featuredImage}
          href={withBase(`/blog/${featuredPost.slug}`)}
          featured
        />
      )}

      {secondaryWithImages.length > 0 && (
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
          {secondaryWithImages.map(({ post, image }) => (
            <PostCard
              title={post.data.title}
              description={post.data.description}
              date={post.data.publishDate.toLocaleDateString('en-US', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
              })}
              image={image}
              href={withBase(`/blog/${post.slug}`)}
            />
          ))}
        </div>
      )}

      <div class="flex justify-center pt-4 md:pt-6">
          <BlogCTA client:idle href={withBase('/blog')}>View all posts</BlogCTA>
      </div>
</section>
