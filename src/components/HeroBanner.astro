---
import AugurLogo from '../assets/augur.svg';
import DiscordLogo from '../assets/discord.svg';
import XLogo from '../assets/x.svg';
import GithubLogo from '../assets/github.svg';
import ForkMeter from './ForkMeter.tsx';
---

<div class="fixed inset-0 h-screen w-screen overflow-scroll place-content-center">
  <div id="hero-banner-container" class="flex flex-col justify-center items-center text-green-500 z-10 text-center min-h-[500px] overflow-y-scroll">
    <div id="social-links" class="absolute top-8 right-10 flex gap-x-8">
      <a id="twitter-link" href="https://x.com/AugurProject" class="text-primary hover:text-foreground focus:text-foreground no-underline font-console text-3xl">
        <XLogo />
      </a>
      <a id="discord-link" href="https://discord.gg/Y3tCZsSmz3" class="text-primary hover:text-foreground focus:text-foreground no-underline font-console text-3xl">
        <DiscordLogo />
      </a>
      <a id="github-link" href="https://github.com/AugurProject/" class="text-primary hover:text-foreground focus:text-foreground no-underline font-console text-3xl">
        <GithubLogo />
      </a>
    </div>

    <AugurLogo id="augur-logo" class:list="text-9xl" />
    
    <p id="prediction-market-text" class="font-console-narrow border border-green-500/20 px-3 py-1 mx-4 text-lg my-5 tracking-[0.4em] leading-tight">
      THE FRONTIER OF PREDICTION MARKETS
    </p>

    <h2 class="text-[2.5em] flex items-center gap-5 title">
      <span id="line-left" class="w-[2rem] h-[1px] bg-foreground"></span>
      <pre id="is-rebooting-text" class="title leading-tight text-[size:clamp(0.27rem,_1vw,_0.6rem)]">
██╗ ███████╗     ██████╗  ███████╗ ██████╗   ██████╗   ██████╗  ████████╗ ██╗ ███╗   ██╗  ██████╗ 
██║ ██╔════╝     ██╔══██╗ ██╔════╝ ██╔══██╗ ██╔═══██╗ ██╔═══██╗ ╚══██╔══╝ ██║ ████╗  ██║ ██╔════╝ 
██║ ███████╗     ██████╔╝ █████╗   ██████╔╝ ██║   ██║ ██║   ██║    ██║    ██║ ██╔██╗ ██║ ██║  ███╗
██║ ╚════██║     ██╔══██╗ ██╔══╝   ██╔══██╗ ██║   ██║ ██║   ██║    ██║    ██║ ██║╚██╗██║ ██║   ██║
██║ ███████║     ██║  ██║ ███████╗ ██████╔╝ ╚██████╔╝ ╚██████╔╝    ██║    ██║ ██║ ╚████║ ╚██████╔╝
╚═╝ ╚══════╝     ╚═╝  ╚═╝ ╚══════╝ ╚═════╝   ╚═════╝   ╚═════╝     ╚═╝    ╚═╝ ╚═╝  ╚═══╝  ╚═════╝ 
        </pre>
      <span id="line-right" class="w-[2rem] h-[1px] bg-foreground"></span>
    </h2>

    <div id="menu-items-container" class="flex flex-col place-items-center font-console-narrow mt-8 text-left w-full max-w-3xl mx-auto">
      <a id="first-menu-item" href="/mission" class="text-green-700 py-1 block hover:text-green-500 focus:text-green-500 hover:text-shadow-[0_0_0.5rem_var(--color-green-500)] focus:text-shadow-[0_0_0.5rem_var(--color-green-500)] focus:outline-none text-2xl">
        A FUTURE THOUGHTFULLY BEING BUILT 
      </a>
      <a href="#" class="text-green-700 hover:text-green-500 focus:text-green-500 py-1 block hover:text-shadow-[0_0_0.5rem_var(--color-green-500)] focus:text-shadow-[0_0_0.5rem_var(--color-green-500)] focus:outline-none text-2xl">
        THE MINDS BEHIND THE REBOOT
      </a>
    </div>

    <div id="fork-meter-container" class="mt-8 absolute bottom-0">
      <ForkMeter 
        client:load
        prediction="ETH WILL BE ABOVE $4,000 BY JULY, 2026"
        round="RD 2"
        remaining_time="120 HRS"
        staked="REP 4,000,000"
        value={75}
        animated={true}
      />
    </div>
  </div>
</div>

<style>
  /* --- Keyframe Definitions --- */
  @keyframes fade-in-up {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes fade-in-down {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes logo-fade-in {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes logo-scale-down {
    from { transform: scale(2) translateY(50%); }
    to { transform: scale(1) translateY(0); }
  }

  @keyframes scale-in {
    from { opacity: 0; transform: scale(0.5); }
    to { opacity: 1; transform: scale(1); }
  }

  @keyframes slide-in-from-right {
    from { opacity: 0; transform: translateX(25px); }
    to { opacity: 1; transform: translateX(0); }
  }

  @keyframes slide-in-from-left {
    from { opacity: 0; transform: translateX(-25px); }
    to { opacity: 1; transform: translateX(0); }
  }

  @keyframes bounce-horizontal {
    0%, 100% {
      transform: translateX(0);
    }
    50% {
      transform: translateX(-8px);
    }
  }

  /* --- Initial Animation States --- */
  #discord-link,
  #twitter-link,
  #github-link,
  #is-rebooting-text,
  #line-left,
  #line-right,
  #prediction-market-text,
  #menu-items-container a,
  #fork-meter-container {
    opacity: 0;
  }

  #augur-logo {
    opacity: 0;
    transform: scale(2) translateY(50%);
  }

  /* --- Menu Pointer (Semantic & Nested) --- */
  #menu-items-container a {
    position: relative; /* Needed for pseudo-element positioning */

    &::before {
      content: '>';
      opacity: 0;
      color: var(--color-foreground);
      display: inline-block;
      margin-right: 0.5rem;
      transition: opacity 0.2s ease-in-out;
    }

    /* Default hover and focus behavior */
    &:hover, &:focus {
      &::before {
        opacity: 1;
        animation: bounce-horizontal 1s ease-in-out infinite;
      }
    }
  }

  /* --- Hover Priority (:has) --- */
  /* When a link is being hovered inside the container... */
  #menu-items-container:has(a:hover) {
    /* ...target the link that is focused but NOT hovered. */
    & a:focus:not(:hover) {
      /* Revert its text color */
      color: var(--color-primary);
      /* Hide its pointer */
      &::before {
        opacity: 0;
        animation: none;
      }
    }
  }

  /* --- Animation Skip State --- */
  #hero-banner-container.animations-skipped #augur-logo {
    opacity: 1;
    transform: scale(1) translateY(0);
  }

  #hero-banner-container.animations-skipped #discord-link,
  #hero-banner-container.animations-skipped #twitter-link,
  #hero-banner-container.animations-skipped #github-link,
  #hero-banner-container.animations-skipped #is-rebooting-text,
  #hero-banner-container.animations-skipped #line-left,
  #hero-banner-container.animations-skipped #line-right,
  #hero-banner-container.animations-skipped #prediction-market-text,
  #hero-banner-container.animations-skipped #menu-items-container a,
  #hero-banner-container.animations-skipped #fork-meter-container {
    opacity: 1;
    transform: none; /* Resets any initial transform */
  }

  /* --- Animation Trigger --- */
  #hero-banner-container.animations-started #twitter-link {
    animation: fade-in-down 0.5s ease-out 7.5s forwards;
  }

  #hero-banner-container.animations-started #discord-link {
    animation: fade-in-down 0.5s ease-out 7.7s forwards;
  }

  #hero-banner-container.animations-started #github-link {
    animation: fade-in-down 0.5s ease-out 7.9s forwards;
  }

  #hero-banner-container.animations-started #augur-logo {
    animation: 
      logo-fade-in 0.5s ease-in 2s forwards,
      logo-scale-down 1s ease-out 4s forwards;
  }

  #hero-banner-container.animations-started #prediction-market-text {
    animation: fade-in-up 0.8s ease-out 5.2s forwards;
  }

  #hero-banner-container.animations-started #line-left {
    animation: slide-in-from-right 0.25s ease-out 6.2s forwards;
  }
  #hero-banner-container.animations-started #line-right {
    animation: slide-in-from-left 0.25s ease-out 6.2s forwards;
  }

  #hero-banner-container.animations-started #is-rebooting-text {
    animation: scale-in 0.4s ease-in 6.5s forwards;
  }

  #hero-banner-container.animations-started #menu-items-container a:nth-of-type(1) {
    animation: fade-in-up 0.5s ease-out 7.3s forwards;
  }
  #hero-banner-container.animations-started #menu-items-container a:nth-of-type(2) {
    animation: fade-in-up 0.5s ease-out 7.5s forwards;
  }
  #hero-banner-container.animations-started #menu-items-container a:nth-of-type(3) {
    animation: fade-in-up 0.5s ease-out 7.7s forwards;
  }

  #hero-banner-container.animations-started #fork-meter-container {
    animation: fade-in-up 0.6s ease-out 8.0s forwards;
  }
</style>

<script>
  import { $animationStore, $shouldSkipAnimations, AnimationPhase, animationActions } from '../stores/animationStore';

  // DOM element references
  let heroBanner: HTMLElement | null = null;
  let firstMenuItem: HTMLAnchorElement | null = null;
  let unsubscribe: (() => void) | null = null;
  let isInitialized = false;
  let lastAppliedPhase: AnimationPhase | null = null;
  let focusTimeout: number | null = null;

  function initializeElements() {
    heroBanner = document.getElementById('hero-banner-container');
    firstMenuItem = document.getElementById('first-menu-item') as HTMLAnchorElement;
  }

  function updateHeroBanner(state: typeof $animationStore.value) {
    if (!heroBanner) return;
    
    // Prevent redundant updates - only update if phase actually changed
    if (lastAppliedPhase === state.phase) {
      return;
    }

    console.log('HeroBanner: Updating from', lastAppliedPhase, 'to', state.phase);
    lastAppliedPhase = state.phase;

    // Clear any pending focus timeout
    if (focusTimeout) {
      clearTimeout(focusTimeout);
      focusTimeout = null;
    }

    // Clear all animation classes
    heroBanner.classList.remove('animations-started', 'animations-skipped');

    // Apply appropriate class based on current phase
    switch (state.phase) {
      case AnimationPhase.INTRO_SKIPPED:
        heroBanner.classList.add('animations-skipped');
        firstMenuItem?.focus();
        break;
      
      case AnimationPhase.ANIMATIONS_ACTIVE:
        heroBanner.classList.add('animations-started');
        // Focus after animations complete (8.3s total)
        focusTimeout = setTimeout(() => {
          firstMenuItem?.focus();
          focusTimeout = null;
        }, 8300);
        break;
      
      case AnimationPhase.INTRO_PLAYING:
      case AnimationPhase.INITIAL:
        // Keep elements hidden until intro completes or is skipped
        break;
    }
  }

  function setupStoreSubscription() {
    // Clean up existing subscription
    if (unsubscribe) {
      console.log('HeroBanner: Cleaning up existing subscription');
      unsubscribe();
      unsubscribe = null;
    }

    // Subscribe to store changes
    unsubscribe = $animationStore.subscribe((state) => {
      updateHeroBanner(state);
    });
    console.log('HeroBanner: Store subscription established');
  }

  function initialize() {
    if (isInitialized) {
      console.log('HeroBanner: Already initialized, skipping');
      return;
    }

    console.log('HeroBanner: Initializing');
    initializeElements();
    setupStoreSubscription();
    
    // Initialize store state based on current URL
    animationActions.initializeFromURL();
    
    // Update UI immediately with current state
    updateHeroBanner($animationStore.get());
    
    isInitialized = true;
  }

  // Listen for intro completion event from Intro component
  function handleIntroFinished() {
    console.log('HeroBanner: Intro finished event received');
    animationActions.startAnimations();
  }

  // Handle view transition events
  function handleViewTransition() {
    console.log('HeroBanner: View transition detected');
    // Re-initialize elements after DOM swap but don't re-setup subscription
    initializeElements();
    
    // Reset tracking variable to allow updates for new page context
    lastAppliedPhase = null;
    
    // Handle navigation in store
    animationActions.handleNavigation();
  }

  // Initialize on load
  initialize();

  // Set up event listeners
  document.addEventListener('introFinished', handleIntroFinished);
  document.addEventListener('astro:page-load', handleViewTransition);
  document.addEventListener('astro:after-swap', handleViewTransition);

  // Clean up on page unload
  window.addEventListener('beforeunload', () => {
    console.log('HeroBanner: Cleaning up on unload');
    if (unsubscribe) {
      unsubscribe();
    }
    if (focusTimeout) {
      clearTimeout(focusTimeout);
    }
  });
</script>
