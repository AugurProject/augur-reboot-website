---
import { ClientRouter } from "astro:transitions";
import "../styles/global.css";
import PerspectiveGridTunnel from "../components/PerspectiveGridTunnel.tsx";
import { withBase } from "../lib/utils";

interface Props {
	title: string;
	description?: string;
	ogImage?: string;
	ogType?: string;
	canonicalURL?: string;
	noindex?: boolean;
	author?: string;
	keywords?: string[];
}

// Safe URL construction for Cloudflare Workers
const siteUrl = Astro.site || new URL(Astro.url.origin);
const defaultCanonicalURL = new URL(Astro.url.pathname, siteUrl).href;

const {
	title,
	description = "Augur is rebooting. The frontier of prediction markets is returning with next-generation oracles and decentralized forecasting technology.",
	ogImage = "/og-image.png",
	ogType = "website",
	canonicalURL = defaultCanonicalURL,
	noindex = false,
	author = "Augur Project",
	keywords = [
		"prediction markets",
		"blockchain",
		"oracles",
		"decentralized finance",
		"forecasting",
		"augur",
		"REP token",
		"cryptocurrency",
		"defi",
		"web3"
	]
} = Astro.props;
---

<!doctype html>
<html lang="en">
	<head>
		<!-- Basic meta tags -->
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="generator" content={Astro.generator} />

		<!-- SEO meta tags -->
		<title>{title}</title>
		<meta name="description" content={description} />
		<meta name="author" content={author} />
		<meta name="keywords" content={keywords.join(", ")} />
		<link rel="canonical" href={canonicalURL} />
		{noindex && <meta name="robots" content="noindex, nofollow" />}

		<!-- Open Graph meta tags -->
		<meta property="og:type" content={ogType} />
		<meta property="og:title" content={title} />
		<meta property="og:description" content={description} />
		<meta property="og:image" content={new URL(ogImage, siteUrl).href} />
		<meta property="og:url" content={canonicalURL} />
		<meta property="og:site_name" content="Augur" />
		<meta property="og:locale" content="en_US" />

		<!-- Twitter Card meta tags -->
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@AugurProject" />
		<meta name="twitter:creator" content="@AugurProject" />
		<meta name="twitter:title" content={title} />
		<meta name="twitter:description" content={description} />
		<meta name="twitter:image" content={new URL(ogImage, siteUrl).href} />

		<!-- Additional meta tags -->
		<meta name="theme-color" content="#2AE7A8" />
		<meta name="msapplication-TileColor" content="#000000" />
		<meta name="application-name" content="Augur" />

		<!-- Icons and manifest -->
		<link rel="icon" type="image/svg+xml" href={withBase('/favicon.svg')} />
		<link rel="apple-touch-icon" href={withBase('/favicon.svg')} />

		<!-- DNS prefetch for external resources -->
		<link rel="dns-prefetch" href="//fonts.googleapis.com" />
		<link rel="dns-prefetch" href="//github.com" />
		<link rel="dns-prefetch" href="//etherscan.io" />

		<!-- Fonts -->
		<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
		<link href="https://fonts.googleapis.com/css2?family=Handjet:wght@300;400&display=swap" rel="stylesheet">

		<!-- Structured data -->
		<script type="application/ld+json">
			{
				"@context": "https://schema.org",
				"@type": "Organization",
				"name": "Augur",
				"url": {JSON.stringify(siteUrl.href)},
				"logo": {JSON.stringify(new URL('/favicon.svg', siteUrl).href)},
				"description": "Decentralized prediction market platform and oracle technology",
				"sameAs": [
					"https://github.com/AugurProject/",
					"https://x.com/AugurProject",
					"https://discord.gg/Y3tCZsSmz3",
					"https://t.me/augurlituus"
				],
				"foundingDate": "2014",
				"industry": "Blockchain Technology",
				"keywords": "prediction markets, blockchain, oracles, decentralized finance"
			}
		</script>

		<ClientRouter />
	</head>
	<body>
		<PerspectiveGridTunnel 
			client:load 
			transition:persist
			transition:persist-props
			transition:name="grid-tunnel"
			numLines={12} 
			animationSpeed={0.1} 
			maxOpacity={0.2} 
			lineColor="#2AE7A8"
			vanishingPoint={0.75}
		/>
		<slot />
	</body>

	<script>
		import { appActions } from '../stores/animationStore';

		// Initialize app store on first page load
		function initializeAppStore() {
			appActions.initializeFromURL();
		}

		function handlePageLoad() {
			// Ensure store is properly initialized after navigation
			appActions.handleNavigation();
		}

		// Initialize on first load
		initializeAppStore();

		// Set up view transition event listeners
		document.addEventListener('astro:page-load', handlePageLoad);
	</script>
</html>
