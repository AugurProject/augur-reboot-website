name: Build and Deploy Augur Site with Fork Risk Monitoring

on:
  schedule:
    # Run every 6 hours at minute 5 for fork risk monitoring
    # Runs at 00:05, 06:05, 12:05, 18:05 UTC
    - cron: '5 */6 * * *'
  workflow_dispatch:
    # Allow manual trigger with deployment control
    inputs:
      deploy_to_production:
        description: 'Deploy to GitHub Pages? (only works on main branch)'
        type: boolean
        default: false
      custom_rpc_url:
        description: 'Custom Ethereum RPC URL for testing'
        required: false
        type: string
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Fetch event cache from gh-pages
        run: |
          # Incremental Event Caching Strategy:
          # - Loads cached events from gh-pages branch
          # - Only queries blockchain for new blocks since last run
          # - Re-queries last 32 blocks for finality safety
          # - Reduces RPC calls from ~51/hour to ~2/6-hours (98% reduction)
          # - See docs/rpc-caching-strategy.md for details

          # Create cache directory in public/ (will be copied to dist/ by Astro build)
          mkdir -p public/cache

          # Try to fetch cache from gh-pages branch
          if git show origin/gh-pages:cache/event-cache.json > public/cache/event-cache.json 2>/dev/null; then
            echo "âœ“ Cache loaded from gh-pages"
            echo "Cache size: $(wc -c < public/cache/event-cache.json) bytes"
            echo "Cache version: $(jq -r '.version // "unknown"' public/cache/event-cache.json)"
            echo "Last queried block: $(jq -r '.lastQueriedBlock // 0' public/cache/event-cache.json)"
          else
            echo "âš ï¸ No cache found on gh-pages, will perform full 7-day query"
            # Create valid empty cache structure (matches EventCache interface)
            NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            jq -n \
              --arg now "$NOW" \
              '{version: "1.0.0", lastQueriedBlock: 0, lastQueriedTimestamp: $now, oldestEventBlock: 0, events: {created: [], contributions: [], completed: []}, metadata: {totalEventsTracked: 0, cacheGeneratedAt: $now, blockchainSyncStatus: "stale"}}' \
              > public/cache/event-cache.json
          fi

      - name: Calculate fork risk data
        run: npm run build:fork-data
        env:
          # Optional: Custom RPC can be provided via secrets or manual dispatch input
          # If not provided, will use public RPCs (no API key needed!)
          ETH_RPC_URL: ${{ secrets.ETH_RPC_URL || github.event.inputs.custom_rpc_url }}

      - name: Check SITE_URL variable
        run: |
          if [ -z "${{ vars.SITE_URL }}" ]; then
            echo "::warning::SITE_URL variable is not set. Astro will not generate sitemaps or canonical URLs. Set it in Settings â†’ Secrets and variables â†’ Actions â†’ Variables"
          else
            echo "SITE_URL is set to: ${{ vars.SITE_URL }}"
          fi

      - name: Build site
        run: npm run build
        env:
          SITE_URL: ${{ vars.SITE_URL }}
          BASE_PATH: ${{ vars.BASE_PATH }}
          PUBLIC_GA_ID: ${{ vars.PUBLIC_GA_ID }}

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist/

      - name: Upload build artifact for summary
        uses: actions/upload-artifact@v4
        with:
          name: augur-site-build-${{ github.run_number }}
          path: dist/
          retention-days: 7

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: |
      github.ref == 'refs/heads/main' &&
      (github.event_name == 'push' ||
       github.event_name == 'schedule' ||
       (github.event_name == 'workflow_dispatch' &&
        github.event.inputs.deploy_to_production == 'true'))

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Checkout gh-pages for cache management
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Detect meaningful changes (smart commit)
        id: changes
        run: |
          # Smart Commit Strategy:
          # - Immediate: Risk data changes (new disputes detected)
          # - Daily: Cache-only updates (midnight run at 00:05 UTC)
          # - Skip: No changes

          # Get current risk from deployed site
          CURRENT_RISK=$(jq -r '.riskPercentage // 0' data/fork-risk.json 2>/dev/null || echo "0")
          CURRENT_BLOCK=$(jq -r '.blockNumber // "Unknown"' data/fork-risk.json 2>/dev/null || echo "Unknown")

          # Get previous risk from git history
          PREVIOUS_RISK=$(git show HEAD:data/fork-risk.json 2>/dev/null | jq -r '.riskPercentage // 0' 2>/dev/null || echo "0")

          # Check if risk changed meaningfully (numeric comparison with rounding tolerance)
          RISK_CHANGED=$(awk -v curr="$CURRENT_RISK" -v prev="$PREVIOUS_RISK" \
            'BEGIN {if (int(curr*100) != int(prev*100)) print "true"; else print "false"}')

          # Get cache stats for commit message (verify file exists)
          EVENTS="0"
          if [ -f cache/event-cache.json ]; then
            EVENTS=$(jq -r '.metadata.totalEventsTracked // 0' cache/event-cache.json 2>/dev/null || echo "0")
          fi
          HOUR=$(date -u +%H)

          # Determine commit strategy
          if [ "$RISK_CHANGED" = "true" ]; then
            # Meaningful risk change - immediate commit
            echo "status=immediate" >> $GITHUB_OUTPUT
            echo "block=$CURRENT_BLOCK" >> $GITHUB_OUTPUT
            echo "risk=$CURRENT_RISK" >> $GITHUB_OUTPUT
            echo "events=$EVENTS" >> $GITHUB_OUTPUT
            echo "âœ… Immediate commit: Risk changed from $PREVIOUS_RISK% to $CURRENT_RISK%"
          elif [ "${EVENTS:-0}" -gt 0 ] && [ "$HOUR" = "00" ]; then
            # Daily cache refresh at midnight (00:05 UTC) - only if events tracked
            echo "status=daily-cache" >> $GITHUB_OUTPUT
            echo "block=$CURRENT_BLOCK" >> $GITHUB_OUTPUT
            echo "events=$EVENTS" >> $GITHUB_OUTPUT
            echo "ðŸ“… Daily cache refresh commit"
          else
            # No meaningful changes
            echo "status=skip" >> $GITHUB_OUTPUT
            echo "â­ï¸ Skipping commit (no meaningful changes)"
          fi

      - name: Commit risk changes
        if: steps.changes.outputs.status == 'immediate'
        run: |
          git add data/fork-risk.json cache/event-cache.json 2>/dev/null || true
          git commit -m "chore: update fork risk data

          Block: ${{ steps.changes.outputs.block }}
          Risk: ${{ steps.changes.outputs.risk }}%
          Cached events: ${{ steps.changes.outputs.events }}

          New dispute activity detected. Risk changed due to active disputes."
          git push origin gh-pages

      - name: Commit daily cache refresh
        if: steps.changes.outputs.status == 'daily-cache'
        run: |
          git add cache/event-cache.json 2>/dev/null || true
          git commit -m "chore: daily event cache refresh

          Block: ${{ steps.changes.outputs.block }}
          Risk: ${{ steps.changes.outputs.risk }}%
          Cached events: ${{ steps.changes.outputs.events }}

          Routine cache update (no new disputes)."
          git push origin gh-pages

      - name: Skip commit
        if: steps.changes.outputs.status == 'skip'
        run: |
          echo "â­ï¸ No meaningful changes, skipping commit"
          git restore --staged data/ cache/ 2>/dev/null || true

  summary:
    needs: build
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: augur-site-build-${{ github.run_number }}
          path: dist/

      - name: Create build summary
        run: |
          echo "## ðŸ“¦ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Extract key metrics from JSON using jq (more reliable than grep)
          if [ -f dist/data/fork-risk.json ]; then
            if command -v jq >/dev/null 2>&1; then
              RISK_LEVEL=$(jq -r '.riskLevel' dist/data/fork-risk.json)
              RISK_PERCENT=$(jq -r '.riskPercentage' dist/data/fork-risk.json)
              LARGEST_BOND=$(jq -r '.metrics.largestDisputeBond' dist/data/fork-risk.json)
              THRESHOLD_PERCENT=$(jq -r '.metrics.forkThresholdPercent' dist/data/fork-risk.json)
              ACTIVE_DISPUTES=$(jq -r '.metrics.activeDisputes' dist/data/fork-risk.json)
              RPC_ENDPOINT=$(jq -r '.rpcInfo.endpoint' dist/data/fork-risk.json)
              RPC_LATENCY=$(jq -r '.rpcInfo.latency' dist/data/fork-risk.json)

              echo "### ðŸš¨ Fork Risk Data" >> $GITHUB_STEP_SUMMARY
              echo "**Risk Level:** ${RISK_LEVEL}" >> $GITHUB_STEP_SUMMARY
              echo "**Risk Percentage:** ${RISK_PERCENT}%" >> $GITHUB_STEP_SUMMARY
              echo "**Largest Dispute Bond:** ${LARGEST_BOND} REP" >> $GITHUB_STEP_SUMMARY
              echo "**Fork Threshold Progress:** ${THRESHOLD_PERCENT}% of 275,000 REP" >> $GITHUB_STEP_SUMMARY
              echo "**Active Disputes:** ${ACTIVE_DISPUTES}" >> $GITHUB_STEP_SUMMARY
              echo "**RPC Used:** ${RPC_ENDPOINT} (${RPC_LATENCY}ms)" >> $GITHUB_STEP_SUMMARY
            else
              echo "**Status:** Fork risk data calculated" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ **Warning:** Fork risk data file not found" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ§ª Testing Instructions" >> $GITHUB_STEP_SUMMARY
          echo "1. **Download:** Click on the artifact \`augur-site-build-${{ github.run_number }}\` above" >> $GITHUB_STEP_SUMMARY
          echo "2. **Extract:** Unzip the downloaded file to a local folder" >> $GITHUB_STEP_SUMMARY
          echo "3. **Test locally:** Run one of these commands in the extracted folder:" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "   # Option 1: Node.js" >> $GITHUB_STEP_SUMMARY
          echo "   npx serve" >> $GITHUB_STEP_SUMMARY
          echo "   " >> $GITHUB_STEP_SUMMARY
          echo "   # Option 2: Python" >> $GITHUB_STEP_SUMMARY
          echo "   python -m http.server 8000" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Deployment status
          if [[ "${{ github.ref }}" == "refs/heads/main" && ("${{ github.event_name }}" == "push" || "${{ github.event_name }}" == "schedule" || ("${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.deploy_to_production }}" == "true")) ]]; then
            echo "### ðŸš€ Deployment Status" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **Production Deployment:** Deployed to GitHub Pages" >> $GITHUB_STEP_SUMMARY
            echo "**Site URL:** ${{ vars.SITE_URL || format('https://{0}.github.io/{1}/', github.repository_owner, github.event.repository.name) }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ðŸ“¦ Artifact Only" >> $GITHUB_STEP_SUMMARY
            echo "**Status:** Build completed, artifact created (no production deployment)" >> $GITHUB_STEP_SUMMARY
            if [[ "${{ github.ref }}" != "refs/heads/main" ]]; then
              echo "**Reason:** Not on main branch (current: ${{ github.ref_name }})" >> $GITHUB_STEP_SUMMARY
            elif [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.deploy_to_production }}" != "true" ]]; then
              echo "**Reason:** Manual trigger with deploy_to_production = false" >> $GITHUB_STEP_SUMMARY
            fi
          fi
