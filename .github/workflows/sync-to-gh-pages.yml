name: Sync Main to GitHub Pages Branch

on:
  push:
    branches: [main]
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write
  pages: write

jobs:
  sync:
    if: github.event_name == 'push' || (github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Checkout gh-pages branch
        run: |
          git checkout gh-pages
          git pull origin gh-pages

      - name: Sync source files from main
        run: |
          # Get latest main content
          git checkout main -- src/
          git checkout main -- public/
          git checkout main -- README.md
          git checkout main -- CLAUDE.md
          git checkout main -- docs/
          git checkout main -- tsconfig.json
          git checkout main -- worker-configuration.d.ts
          git checkout main -- wrangler.jsonc
          
          # Restore gh-pages specific files
          git checkout gh-pages -- astro.config.mjs
          git checkout gh-pages -- .github/workflows/deploy.yml
          git checkout gh-pages -- public/.nojekyll
          
          # Handle package.json - sync dependencies but preserve any gh-pages specific scripts
          git checkout main -- package.json
          git checkout main -- package-lock.json

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet HEAD; then
            echo "No changes to commit"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            git status --porcelain
          fi

      - name: Commit and push changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git add .
          git commit -m "Sync from main: $(git log main -1 --pretty=format:'%h %s')"
          git push origin gh-pages

      - name: Summary
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          echo "âœ… Successfully synced changes from main to gh-pages"
          echo "ðŸš€ GitHub Pages will rebuild automatically"